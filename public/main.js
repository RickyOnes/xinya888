let e,t;try{e=window.supabase.createClient("https://iglmqwpagzjadwauvchh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnbG1xd3BhZ3pqYWR3YXV2Y2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODk4NDAsImV4cCI6MjA2NjQ2NTg0MH0.Mtiwp31mJvbLRTotbrb4_DobjjpM4kg9f4-G8oWz85E")}catch(e){ce("系统初始化失败，请刷新页面或联系管理员","error")}const n=document.getElementById("dateRangePicker"),o=document.getElementById("queryBtn"),a=document.getElementById("clearBtn"),s=document.getElementById("summaryTable").querySelector("tbody"),l=document.getElementById("detailTable").querySelector("tbody"),i=document.getElementById("loading"),r=document.getElementById("totalQuantity"),c=document.getElementById("totalAmount"),d=document.getElementById("totalProducts"),u=document.getElementById("totalBrands"),p=(document.getElementById("toggleDetails"),document.getElementById("detailSection")),h=document.getElementById("totalProfit"),m=(document.getElementById("switchWarehouseBtn"),document.getElementById("warehouseSelector")),g=document.getElementById("warehouseOptions"),y=document.getElementById("brandSelector"),f=document.getElementById("brandOptions"),b=document.getElementById("productSelector"),v=document.getElementById("productOptions"),w=document.getElementById("customerSelector"),E=document.getElementById("customerOptions"),C=document.getElementById("authContainer"),x=document.getElementById("appContainer"),L=document.getElementById("loginForm"),q=document.getElementById("registerForm"),_=document.getElementById("loginEmail"),$=document.getElementById("loginPassword"),k=document.getElementById("registerEmail"),S=document.getElementById("registerPassword"),I=document.getElementById("registerPhone"),B=document.getElementById("loginBtn"),M=document.getElementById("registerBtn"),T=document.getElementById("forgotPasswordLink"),D=document.querySelectorAll(".auth-tab"),V=document.getElementById("userStatus"),A=document.getElementById("userInfo"),H=document.getElementById("userName"),F=document.getElementById("userMenu"),O=document.getElementById("logoutBtn"),z=document.getElementById("chartToggleBtn"),P=document.getElementById("returnsTableContainer"),W=document.getElementById("returnsTable"),j=document.getElementById("exportDetails");let X,R,N,J,Y=[],Z=[],G=[],Q={},U=null,K=[],ee=null,te="default",ne=[],oe=[],ae="",se="",le="chart";function ie(e){return"number"!=typeof e?"0":e.toLocaleString("zh-CN",{minimumFractionDigits:0,maximumFractionDigits:2})}function re(){const e=new Date,n=new Date;1===e.getDate()?(n.setMonth(n.getMonth()-1),n.setDate(1),e.setMonth(e.getMonth()-1),e.setDate(new Date(e.getFullYear(),e.getMonth()+1,0).getDate())):(n.setDate(1),e.setDate(e.getDate()-1)),t.setDate([n,e])}function ce(e,t="error"){const n=document.getElementById("custom-alert");n&&n.remove();const o=document.createElement("div");o.id="custom-alert",o.className=`rounded-alert ${t}`,o.innerHTML=`\n    <div class="alert-content">\n      <i class="fas fa-${"error"===t?"exclamation-circle":"check-circle"}"></i>\n      <span>${e}</span>\n    </div>\n  `,document.body.appendChild(o);const a=o.offsetWidth,s=(window.innerWidth-a)/2;o.style.top="20px",o.style.left=`${s}px`,setTimeout(()=>{o.classList.add("fade-out"),setTimeout(()=>o.remove(),300)},2e3)}function de(){if(p.classList.contains("visible")){p.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}te="default"===te?"longqiao":"default";const e=document.querySelector(".filters-row");"longqiao"===te?e.classList.add("longqiao"):e.classList.remove("longqiao"),function(){const e=document.querySelector("header h1"),t=document.getElementById("profitCard"),n=document.getElementById("totalProducts").closest(".stat-card");"longqiao"===te?(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 隆桥仓库销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-warehouse)").innerHTML='<i class="fas fa-user"></i> 销售人员',t.style.display="block"):(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 多多买菜销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-user)").innerHTML='<i class="fas fa-warehouse"></i> 仓库',t.style.display="none",n.style.display="block");const o=document.getElementById("customerFilterGroup");o&&(o.style.display="longqiao"===te?"block":"none")}(),z.style.display="default"===te?"flex":"none",we(),re(),le="returns",ge(),ye().then(()=>{X.reset(),R.reset(),N.reset(),J&&J.reset(),function(){const e=document.querySelector("#detailTable thead");let t=`\n    <tr>\n      <th>日期</th>\n      <th>${"longqiao"===te?"客户名称":"商品ID"}</th> \n      <th>商品名称</th>\n      <th>品牌</th>\n      <th>${"longqiao"===te?"销售人员":"仓库"}</th>\n      <th>销量</th>\n      <th>${"longqiao"===te?"成本":"单价"}</th>\n      <th>金额</th>\n  `;"longqiao"===te&&(t+="<th>毛利</th>");t+="</tr>",e.innerHTML=t}(),fe(),_e()})}class ue{constructor(e,t,n){this.selector=e,this.optionsContainer=t,this.placeholder=n,this.selectedValues=[],this.allOptions=[],this.clearBtn=e.querySelector(".clear-btn"),this.initEvents()}initEvents(){this.selector.addEventListener("click",e=>this.toggleDropdown(e)),this.clearBtn.addEventListener("click",e=>this.clearSelection(e)),this.optionsContainer.addEventListener("change",e=>this.handleOptionChange(e)),this.optionsContainer.addEventListener("mouseenter",()=>this.optionsContainer.classList.add("active")),this.optionsContainer.addEventListener("mouseleave",()=>this.optionsContainer.classList.remove("active"))}toggleDropdown(e){if(e.target.classList.contains("tag-remove")||e.target.classList.contains("tag")||e.target.closest(".tag-remove")||e.target.closest(".tag"))return;e.stopPropagation(),pe();if(!this.optionsContainer.classList.contains("visible")){this.optionsContainer.classList.add("visible"),U=this.optionsContainer;this.selector.querySelector(".arrow").classList.replace("fa-chevron-down","fa-chevron-up"),this.positionDropdown()}}positionDropdown(){const e=this.selector.getBoundingClientRect(),t=this.selector.parentElement.getBoundingClientRect();this.optionsContainer.style.width=`${e.width}px`,this.optionsContainer.style.left=e.left-t.left+"px",this.optionsContainer.style.top=e.bottom-t.top+"px"}clearSelection(e){e.stopPropagation(),this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1),("brandSelector"===this.selector.id||"productSelector"===this.selector.id)&&(K=[],he())}handleOptionChange(e){if(!e.target.matches('input[type="checkbox"]'))return;const t=e.target,n=t.value;if(t.id.startsWith("selectAll")){const e=this.optionsContainer.querySelectorAll(`input[type="checkbox"]:not([id="${t.id}"])`);t.checked?(this.selectedValues=this.allOptions.map(e=>e.value),e.forEach(e=>e.checked=!0)):(this.selectedValues=[],e.forEach(e=>e.checked=!1))}else{if(t.checked)this.selectedValues.includes(n)||this.selectedValues.push(n);else{const e=this.selectedValues.indexOf(n);e>-1&&this.selectedValues.splice(e,1)}this.updateSelectAllState()}this.updateDisplay(),"brandSelector"===this.selector.id&&(K=[],he(),"longqiao"===te&&function(){const e=R.selectedValues,t=X.selectedValues;let n=[];n=e.length>0||t.length>0?ne.filter(n=>oe.some(o=>o.customer===n&&(0===e.length||e.includes(o.brand))&&(0===t.length||t.includes(o.sales)))):ne;J.setOptions(n.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),J&&J.reset()}()),"warehouseSelector"===this.selector.id&&function(){if(!oe||0===oe.length)return;try{let e=[...oe];"longqiao"===te?X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.sales))):X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.warehouse)));const t=new Map;if(Q={},e.forEach(e=>{e.product_id&&(t.has(e.product_id)||t.set(e.product_id,{product_id:e.product_id,product_name:e.product_name||"未知商品"}),Q[e.product_id]=e.brand||"无品牌")}),G=Array.from(t.values()),Z=[...new Set(Object.values(Q))].sort(),R.setOptions(Z.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),he(),"longqiao"===te){const t=[...new Set(e.map(e=>e.customer).filter(e=>e))].sort();J.setOptions(t.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),J&&J.reset(),R&&R.reset()}}catch(e){ce(`重新加载品牌和商品选项失败: ${e}`,"error")}}()}updateDisplay(){const e=this.selector.querySelector(".placeholder"),t=this.selector.querySelector(".selected-display"),n=this.selector.querySelector(".arrow");if(t.innerHTML="",0===this.selectedValues.length)return e.textContent=`全部${this.placeholder}`,e.style.display="block",t.style.display="none",n.style.display="block",n.classList.replace("fa-times","fa-chevron-down"),void(this.clearBtn.style.display="none");e.style.display="none",t.style.display="flex";const o=this.selectedValues.slice(0,5),a=this.selectedValues.length-5;if(o.forEach(e=>{const n=this.allOptions.find(t=>t.value===e);n&&t.insertAdjacentHTML("beforeend",`\n        <div class='tag' data-value='${e}'>\n          ${n.label}\n          <span class='tag-remove'><i class="far fa-circle-xmark"></i></span> \n        </div>\n      `)}),a>0){const e=document.createElement("div");e.className="tag more-tag",e.textContent=`...等${this.selectedValues.length}项`,t.appendChild(e)}n.style.display="none",this.clearBtn.style.display="block"}reset(){this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1)}updateSelectAllState(){const e=this.optionsContainer.querySelector('input[id^="selectAll"]');if(e){const t=this.optionsContainer.querySelectorAll('input[type="checkbox"]:not([id^="selectAll"])');e.checked=t.length>0&&Array.from(t).every(e=>e.checked)}}setOptions(e){this.allOptions=e,this.renderOptions(),this.updateDisplay()}renderOptions(){this.optionsContainer.innerHTML="";const e=document.createElement("div");e.className="option",e.innerHTML=`\n      <input type="checkbox" id="selectAll${this.selector.id}">\n      <label for="selectAll${this.selector.id}">全选</label>\n    `,this.optionsContainer.appendChild(e),this.allOptions.forEach(e=>{const t=document.createElement("div");t.className="option",t.innerHTML=`\n        <input type="checkbox" id="${this.selector.id}-${e.value}" \n              value="${e.value}" ${this.selectedValues.includes(e.value)?"checked":""}>\n        <label for="${this.selector.id}-${e.value}">${e.label}</label>\n      `,this.optionsContainer.appendChild(t)})}}function pe(){document.querySelectorAll(".options-container").forEach(e=>{e.classList.remove("visible");const t=e.previousElementSibling.querySelector(".arrow");t&&t.classList.replace("fa-chevron-up","fa-chevron-down")}),U=null}function he(){v.innerHTML="";const e=document.createElement("div");e.className="option",e.id="productSelectAll",e.innerHTML='\n    <input type="checkbox" id="selectAllProducts">\n    <label for="selectAllProducts">全选</label>\n  ',v.appendChild(e);let t=[],n=R.selectedValues.length;n>0?t=G.filter(e=>Q[e.product_id]&&R.selectedValues.includes(Q[e.product_id])):(t=G,n="全部"),N.selectedValues=[],t.forEach(e=>{const t=document.createElement("div");t.className="option";const n=N.selectedValues.includes(e.product_id);t.innerHTML=`\n      <input type="checkbox" id="product-${e.product_id}" \n             value="${e.product_id}" ${n?"checked":""}>\n      <label for="product-${e.product_id}">${e.product_name}</label>\n    `,v.appendChild(t)});b.querySelector(".placeholder").textContent=0===R.selectedValues.length?"全部商品":`已筛选${n}个品牌`,N.setOptions(t.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label)))}function me(){if(!W)return;const e=W.querySelector("tbody"),t=W.closest(".returns-table-container"),n=t.querySelector(".returns-summary");if(n&&n.remove(),!e)return;e.innerHTML="";const o=ve();if(!o||0===o.length)return void(e.innerHTML='\n      <tr>\n        <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n          未找到记录\n        </td>\n      </tr>\n    ');const a={};o.forEach(e=>{const t=e.product_id;a[t]||(a[t]={product_id:t,product_name:e.product_name,inbounds:0,sales_quantity:0,sorting_difference:0,returns:0}),a[t].inbounds+=e.inbounds||0,a[t].sales_quantity+=e.quantity||0,a[t].returns+=e.returns||0,a[t].sorting_difference+=e.difference||0});const s=Object.values(a).map(e=>{const t=e.sales_quantity-e.inbounds+e.returns+e.sorting_difference;return{...e,difference:t}}).filter(e=>0!==e.difference);s.sort((e,t)=>Math.abs(t.difference)-Math.abs(e.difference));const l=Object.values(a).reduce((e,t)=>e+(t.inbounds||0),0),i=Object.values(a).reduce((e,t)=>e+(t.returns||0),0),r=Object.values(a).reduce((e,t)=>e+(t.sales_quantity||0),0),c=Object.values(a).reduce((e,t)=>e+(t.sorting_difference||0),0),d=r-l+i+c,u=document.createElement("div");u.className="returns-summary",u.innerHTML='\n    <div class="summary-chart-container">\n      <canvas id="returnsSummaryChart"></canvas>\n    </div>\n  ',t.insertBefore(u,t.firstChild),setTimeout(()=>{!function(e,t,n,o,a){const s=document.getElementById("returnsSummaryChart");if(!s)return;s.chart&&s.chart.destroy();s.chart=new Chart(s,{type:"bar",data:{labels:["总入库(份)","总销售(份)","总退货(份)","分拣差异(份)","总差异(份)"],datasets:[{label:"数量",data:[e,t,n,o,Math.abs(a)],backgroundColor:["rgba(54, 162, 235, 0.7)","rgba(75, 192, 192, 0.7)","rgba(255, 99, 132, 0.7)","rgba(255, 159, 64, 0.7)",a<0?"rgba(255, 96, 64, 0.9)":"rgba(153, 102, 255, 0.9)"],borderColor:["rgba(54, 162, 235, 1)","rgba(75, 192, 192, 1)","rgba(255, 99, 132, 1)","rgba(255, 159, 64, 1)",a<0?"rgba(255, 105, 64, 1)":"rgba(153, 102, 255, 1)"],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:"入库销售退货数据分析",color:"#222",font:{size:window.innerWidth<=768?16:18,weight:"bold"},padding:{top:10,bottom:20}},tooltip:{callbacks:{label:function(e){const t=e.raw;return`数量: ${ie(4===e.dataIndex?a:t)}`}}},datalabels:{anchor:"end",align:"top",formatter:function(e,t){return 4===t.dataIndex?ie(Math.abs(a)):ie(e)},font:{weight:"bold",size:14},color:function(e){e.dataset.data[e.dataIndex];return 4===e.dataIndex?a<0?"#e53e3e":"#26cd3c":3===e.dataIndex?a>0?"#e53e3e":"#26cd3c":"#333"}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return ie(e)}},grid:{display:!1}},x:{grid:{display:!1}}},minBarLength:2},plugins:[ChartDataLabels]})}(l,r,i,c,d)},0),0!==s.length?s.forEach(t=>{const n=document.createElement("tr"),o=t.difference<0?'style="color: #e53e3e; font-weight: bold;"':'style="color: #26cd3c; font-weight: bold;"';n.innerHTML=`\n      <td>${t.product_name||"--"}</td>\n      <td>${ie(t.inbounds)}</td>\n      <td>${ie(t.sales_quantity)}</td>\n      <td>${ie(t.returns+t.sorting_difference)}</td>\n      <td ${o}>${ie(t.difference)}</td>\n    `,e.appendChild(n)}):e.innerHTML='\n      <tr>\n        <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block; color: #28a745;"></i>\n          所有记录入库-销售-退货=0，无差异记录\n        </td>\n      </tr>\n    '}async function ge(){if("chart"===le){le="returns",z.innerHTML='<i class="fas fa-chart-pie"></i>';const e=document.getElementById("chartContainer");e&&(e.style.display="none"),P.style.display="block",P.classList.add("visible"),me()}else{le="chart",z.innerHTML='<i class="fas fa-exchange-alt"></i>';const e=document.getElementById("chartContainer");e&&(e.style.display="block"),P.style.display="none",P.classList.remove("visible")}}async function ye(){try{i.style.display="block",xe();const n=t.selectedDates,o=n[0],a=n[1],s=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;ae=s(o),se=s(a);const l="longqiao"===te?"longqiao_records":"sales_records",r="longqiao"===te?["sale_date","product_id","product_name","sales","quantity","customer","amount","cost","brand"]:["sale_date","product_id","product_name","warehouse","quantity","unit_price","brand","pieces","returns","inbounds","difference"],c={sale_date:{gte:ae,lte:se}};if(console.time("加载销售记录时间"),oe=await async function(t,n,o={}){try{const a=5e4;let s=[],l=0,i=!0,r=e.from(t).select(n.join(","));for(Object.entries(o).forEach(([e,t])=>{Array.isArray(t)?r=r.in(e,t):void 0!==t&&(r="object"==typeof t&&t.gte&&t.lte?r.gte(e,t.gte).lte(e,t.lte):r.eq(e,t))});i;){let e=r.range(l,l+a-1);const{data:t,error:n}=await e;if(n)throw n;t&&t.length>0&&(s=[...s,...t]),i=t.length===a,l+=a}return s}catch(e){throw ce(`从 ${t} 获取数据失败:${e}`,"error"),e}}(l,r,c),console.timeEnd("加载销售记录时间"),oe.length>0){const e="longqiao"===te?"sales":"warehouse";Y=[...new Set(oe.map(t=>t[e]))].filter(e=>e).sort()}if(Q={},oe.length>0){const e=new Map;oe.forEach(t=>{t.product_id&&!e.has(t.product_id)&&e.set(t.product_id,{product_id:t.product_id,product_name:t.product_name}),t.product_id&&t.brand&&(Q[t.product_id]=t.brand)}),G=Array.from(e.values()),Z=[...new Set(oe.map(e=>e.brand))].filter(e=>e).sort()}return"longqiao"===te&&oe.length>0&&(ne=[...new Set(oe.map(e=>e.customer))].filter(e=>e).sort()),X=new ue(m,g,"longqiao"===te?"销售人员":"仓库"),R=new ue(y,f,"品牌"),N=new ue(b,v,"商品"),J=new ue(w,E,"客户"),J.setOptions(ne.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),X.setOptions(Y.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),R.setOptions(Z.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),N.setOptions(G.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label))),"longqiao"===te&&1===Z.length&&setTimeout(()=>{fe()},0),Promise.resolve()}catch(e){return ce(`筛选选项加载失败: ${e.message}`,"error"),Promise.reject(e)}finally{i.style.display="none",Le()}}function fe(){if(p.classList.contains("visible")){p.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}s.innerHTML="",l.innerHTML="",we();try{let e=oe;"longqiao"===te?X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.sales))):X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.warehouse))),R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.brand))),N.selectedValues.length>0&&(e=e.filter(e=>N.selectedValues.includes(e.product_id))),"longqiao"===te&&J&&J.selectedValues.length>0&&(e=e.filter(e=>J.selectedValues.includes(e.customer))),function(e){const t=document.getElementById("summaryTable");let n=t.querySelector("thead");n||(n=document.createElement("thead"),t.insertBefore(n,t.firstChild));let o="<tr><th>品牌</th><th>总件数</th><th>总金额</th>";"longqiao"===te&&(o+="<th>总毛利</th><th>费用发放</th>");o+="</tr>",n.innerHTML=o;let a=t.querySelector("tbody");a||(a=document.createElement("tbody"),t.appendChild(a));if(!e||0===e.length){r.textContent="0",c.textContent="¥0.00",d.textContent="0",u.textContent="0","longqiao"===te&&(h.textContent="¥0.00");const e="longqiao"===te?5:3;return void(a.innerHTML=`\n      <tr>\n          <td colspan="${e}" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n          无汇总数据\n        </td>\n      </tr>\n    `)}let s=0,l=0,i=0,p=0;const m=new Set,g=new Set,y=new Map;e.forEach(e=>{let t,n;if(e.product_id&&g.add(e.product_id),e.brand&&m.add(e.brand),"longqiao"===te)if(t=e.amount||0,n=e.cost||0,0===t)p+=n;else{const o=e.quantity||0;s+=o,l+=t,i+=t-n}else{const o=e.pieces||0,a=e.quantity||0,i=e.unit_price||0;t=a*i,s+=o,l+=t,n=i}if("longqiao"!==te||0!==t){const o=e.brand||"未知品牌";y.has(o)||y.set(o,{brand:o,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const a=y.get(o);"longqiao"===te?(a.total_quantity+=e.quantity||0,a.total_amount+=t,a.total_cost+=n,a.profit+=t-n):(a.total_quantity+=e.pieces||0,a.total_amount+=t)}if("longqiao"===te&&0===t){const t=e.brand||"未知品牌";y.has(t)||y.set(t,{brand:t,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});y.get(t).free_issue+=n}});const f="longqiao"===te&&(1===m.size||1===Z.length),b=1===m.size?Array.from(m)[0]:1===Z.length?Z[0]:null;if(f&&b){const t=new Map;let o=0,s=0,l=0,i=0;const p=new Set;e.forEach(e=>{if(e.brand===b){let n,a;if(e.product_id&&p.add(e.product_id),"longqiao"===te){n=e.amount||0,a=e.cost||0;const r=e.sales||"未知销售人员";t.has(r)||t.set(r,{sales:r,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const c=t.get(r);if(0===n)c.free_issue+=a,i+=a;else{const t=e.quantity||0;c.total_quantity+=t,c.total_amount+=n,c.profit+=n-a,o+=t,s+=n,l+=n-a}}}}),r.textContent=ie(o),c.textContent=`¥${ie(s)}`,h.textContent=`¥${ie(l)}`,u.textContent=`¥${ie(i)}`,u.style.color="#e53e3e",d.textContent=ie(p.size);document.querySelectorAll(".stat-card .stat-label")[3].textContent="费用发放",h.style.color=l<=0?"#e53e3e":"#4361ee",n.innerHTML="<tr><th>销售人员</th><th>总件数</th><th>总金额</th><th>总毛利</th><th>费用发放</th></tr>";const m=Array.from(t.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",m.forEach(e=>{const t=document.createElement("tr"),n=e.profit<0?'style="color: #e53e3e; font-weight: bold;"':"";t.innerHTML=`\n          <td>${e.sales}</td>\n          <td>${ie(e.total_quantity)}</td>\n          <td>¥${ie(e.total_amount)}</td>\n          <td ${n}>¥${ie(e.profit)}</td> \n          <td>¥${ie(e.free_issue)}</td> \n      `,a.appendChild(t)}),m.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data"><br><br>无销售人员数据可展示</div>',z.style.display="default"===te?"flex":"none",0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{const t=["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"];if(e>t.length)for(let n=t.length;n<e;n++)t.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return t.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.sales),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"92%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:window.innerWidth<=768?10:14,weight:"bold"},padding:window.innerWidth<=768?9:20,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"销售人员销售金额占比",font:{size:window.innerWidth<=768?16:18,weight:"bold"},color:"#222",padding:{top:20,bottom:10}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:13,weight:"bold"},bodyFont:{size:window.innerWidth<=768?10:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ie(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(m):we()}else{r.textContent=ie(s),c.textContent=`¥${ie(l)}`;const t=document.querySelectorAll(".stat-card .stat-label");"longqiao"===te?(u.textContent=`¥${ie(p)}`,u.style.color="#e53e3e",t[3].textContent="费用发放",!(i<=0)||(h.style.color="#e53e3e"),h.textContent=`¥${ie(i)}`):(u.textContent=ie(m.size),u.style.color="",t[3].textContent="品牌数量"),d.textContent=ie(g.size);const n=Array.from(y.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",n.forEach(e=>{const t=document.createElement("tr");let n=`\n          <td>${e.brand}</td>\n          <td>${ie(e.total_quantity)}</td>\n          <td>¥${ie(e.total_amount)}</td>\n      `;if("longqiao"===te){n+=`\n              <td ${e.profit<0?'style="color: #e53e3e; font-weight: bold;"':""}>¥${ie(e.profit)}</td> \n              <td>¥${ie(e.free_issue)}</td> \n          `}t.innerHTML=n,a.appendChild(t)}),e&&e.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data"><br><br>无品牌数据可展示</div>',z.style.display="default"===te?"flex":"none",0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{if(baseColors="longqiao"===te?["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"]:["#26cd3cff","#FFCE56","#f54444ff","#36A2EB","#F15BB5","#9966FF","#FF9F40","#6A4C93","#4BC0C0","#1982C4"],e>baseColors.length)for(let t=baseColors.length;t<e;t++)baseColors.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return baseColors.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.brand),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"92%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:window.innerWidth<=768?10:14,weight:"bold"},padding:window.innerWidth<=768?9:20,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"品牌销售金额占比",font:{size:window.innerWidth<=768?16:18,weight:"bold"},color:"#222",padding:{top:20,bottom:10}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:13,weight:"bold"},bodyFont:{size:window.innerWidth<=768?10:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ie(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(n):we()}setTimeout(()=>{!function(){const e=document.getElementById("returnsTableContainer"),t=document.querySelector(".summary-table-container"),n=document.querySelector(".chart-container");if(t&&n){const o=t.offsetHeight;n.style.height=`${o}px`,e.style.maxHeight=`${o}px`,console.log("syncContainersDimensions",o),console.log("syncContainersDimensions:",e.style.height,e.style.maxHeight),n.chartInstance&&n.chartInstance.resize()}}()},0)}(e),be(e,!1),"returns"===le&&me()}catch(e){console.error("查询错误详情:",e),i.innerHTML=`\n      <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n        <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">数据加载失败</p>\n        <p>${e.message}</p>\n      </div>\n    `}}function be(e,t=!1){const n=document.getElementById("detailCount");e&&0!==e.length?n.textContent=`(${e.length}条)`:n.textContent="(0条数据)",t&&setTimeout(()=>{try{const t=l;if(t.innerHTML="",e&&e.length>0&&e.sort((e,t)=>new Date(t.sale_date)-new Date(e.sale_date)),!e||0===e.length)return void(t.innerHTML=`\n          <tr>\n            <td colspan="${"longqiao"===te?9:8}" style="text-align: center; padding: 30px; color: #6c757d;">\n              <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n              未找到匹配的记录\n            </td>\n          </tr>\n        `);e.forEach(e=>{const n=document.createElement("tr");let o,a,s;if("longqiao"===te?(o=e.amount||0,a=e.sales||"--",s=e.cost||0):(o=(e.quantity||0)*(e.unit_price||0),a=e.warehouse||"--",s=e.unit_price||0),n.innerHTML=`\n          <td>${e.sale_date||"--"}</td>\n          <td>${"longqiao"===te?e.customer||"--":e.product_id||"--"}</td>\n          <td>${e.product_name||"--"}</td>\n          <td>${e.brand||"--"}</td>\n          <td>${a}</td>\n          <td>${ie(e.quantity||0)}</td>\n          <td>${s}</td>\n          <td>¥${ie(o)}</td>\n        `,"longqiao"===te){const t=(e.amount||0)-(e.cost||0),o=t<0?'style="color: #e53e3e; font-weight: bold;"':"";n.innerHTML+=`<td ${o}>¥${ie(t)}</td>`}t.appendChild(n)})}catch(e){console.error("渲染详细表格时出错:",e),l.innerHTML=`\n        <tr>\n          <td colspan="${"longqiao"===te?9:8}" style="text-align: center; padding: 30px; color: #e53e3e;">\n            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n            <p>渲染表格时发生错误</p>\n          </td>\n        </tr>\n      `}},0)}function ve(){let e=oe;return"longqiao"===te?X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.sales))):X.selectedValues.length>0&&(e=e.filter(e=>X.selectedValues.includes(e.warehouse))),R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.brand))),N.selectedValues.length>0&&(e=e.filter(e=>N.selectedValues.includes(e.product_id))),"longqiao"===te&&J&&J.selectedValues.length>0&&(e=e.filter(e=>J.selectedValues.includes(e.customer))),e}function we(){const e=document.getElementById("chartContainer");e.innerHTML='<div class="no-chart-data"><br><br>无品牌数据可展示</div>',z.style.display="default"===te?"flex":"none",e.chartInstance&&(e.chartInstance.destroy(),e.chartInstance=null)}function Ee(){X.reset(),R.reset(),N.reset(),J&&J.reset(),he(),we(),re(),le="returns",ge(),ye().then(()=>{fe()})}function Ce(){p.classList.toggle("visible");const e=document.querySelector("#toggleDetails i");p.classList.contains("visible")?(e.classList.replace("fa-chevron-down","fa-chevron-up"),i&&(i.style.display="block",xe()),p.classList.contains("visible")?(be(ve(),!0),setTimeout(()=>{i&&(i.style.display="none",Le())},300)):i&&(i.style.display="none",Le())):(e.classList.replace("fa-chevron-up","fa-chevron-down"),l&&(l.innerHTML=""))}function xe(){let e=document.getElementById("loading-overlay");e?e.style.display="flex":(e=document.createElement("div"),e.id="loading-overlay",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(255, 255, 255, 0.2);\n      z-index: 999;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      backdrop-filter: blur(2px);\n    ",document.body.appendChild(e))}function Le(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}async function qe(){if(/MicroMessenger/i.test(navigator.userAgent))ce("微信浏览器不支持此功能，请在浏览器中打开网页导出数据。","warning");else{if("undefined"==typeof XLSX)try{if(i.style.display="block",xe(),await async function(){try{const e=document.createElement("script");return e.src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",new Promise((t,n)=>{e.onload=()=>t(window.XLSX),e.onerror=()=>n(new Error("XLSX库加载失败")),document.head.appendChild(e)})}catch(e){return ce(`数据导出错误：${e}`,"error"),null}}(),!window.XLSX)throw new Error("XLSX库加载失败")}catch(e){return void ce("导出功能暂时不可用。")}try{const e=ve();if(!e||0===e.length)return void ce("没有数据可导出","warning");const t=XLSX.utils.book_new(),n=e.map(e=>{let t,n,o;"longqiao"===te?(t=e.amount||0,n=e.sales||"--",o=e.cost||0):(t=(e.quantity||0)*(e.unit_price||0),n=e.warehouse||"--",o=e.unit_price||0);const a={"日期":e.sale_date||"--"};if("longqiao"===te?a["客户名称"]=e.customer||"--":a["商品ID"]=e.product_id||"--",a["商品名称"]=e.product_name||"--",a["品牌"]=e.brand||"--","longqiao"===te?a["销售人员"]=n:a["仓库"]=n,a["销量"]=e.quantity||0,"longqiao"===te?a["成本"]=o:a["单价"]=o,a["金额"]=t,"longqiao"===te){const t=(e.amount||0)-(e.cost||0);a["毛利"]=t}return a}),o=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(t,o,"销售记录");const a=`${"longqiao"===te?"隆桥仓库":"多多买菜"}_销售记录_${ae}_${se}.xlsx`;i.style.display="none",Le(),XLSX.writeFile(t,a),ce("数据导出成功","success")}catch(e){ce(`导出失败: ${e.message}`,"error")}}}function _e(){const e=document.getElementById("totalProducts").closest(".stat-card");"longqiao"===te&&window.innerWidth<800?e.style.display="none":"longqiao"===te&&(e.style.display="block")}function $e(){let e;t=flatpickr(n,{mode:"range",dateFormat:"Y-m-d",static:!0,onChange:function(e){2===e.length&&s()}}),t&&re(),j.addEventListener("click",qe),z.addEventListener("click",ge);const s=()=>{clearTimeout(e),e=setTimeout(()=>{ye().then(()=>{fe(),_e()}).catch(console.error)},500)};ye().then(()=>{o.addEventListener("click",fe),a.addEventListener("click",Ee),document.getElementById("toggleDetails").addEventListener("click",Ce),fe()}).catch(e=>{console.error("初始化失败:",e),i.innerHTML=`\n        <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n          <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n          <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">初始化失败</p>\n          <p>${e.message}</p>\n        </div>\n      `,i.style.display="block"}),document.addEventListener("click",e=>{m.contains(e.target)||g.contains(e.target)||y.contains(e.target)||f.contains(e.target)||b.contains(e.target)||v.contains(e.target)||w.contains(e.target)||E.contains(e.target)||pe()},!0),document.querySelectorAll(".select-box").forEach(e=>{e.addEventListener("click",t=>{const n=t.target.closest(".tag-remove");if(!n)return;t.stopPropagation(),t.preventDefault();const o=n.closest(".tag"),a=e.id,s=o.dataset.value;if("warehouseSelector"===a){const e=g.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("brandSelector"===a){const e=f.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("productSelector"===a){const e=v.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("customerSelector"===a){const e=E.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}})}),window.addEventListener("scroll",()=>{pe()}),window.addEventListener("resize",()=>{if(U){const e=U.previousElementSibling;e&&("warehouseSelector"===e.id?X.positionDropdown():"brandSelector"===e.id?R.positionDropdown():"productSelector"===e.id?N.positionDropdown():"customerSelector"===e.id&&J.positionDropdown())}}),function(){const e=document.querySelector(".chart-container"),t=document.querySelector(".returns-table-container"),n=document.querySelector(".summary-table-container");if(!e||!t||!z)return;function o(){let n;n="none"!==e.style.display?e:t,z.style.transition="none";const o=n.getBoundingClientRect(),a=n.parentElement.getBoundingClientRect(),s=o.left-a.left+10,l=o.top-a.top+10;z.style.left=`${s}px`,z.style.top=`${l}px`}if(window.ResizeObserver){const a=new ResizeObserver(o);a.observe(e),a.observe(t),a.observe(n)}o()}()}document.addEventListener("DOMContentLoaded",async()=>{const t=document.querySelector(".progress-bar"),n=document.querySelector(".loading-container p"),a=[{condition:()=>window.supabase,name:"Supabase"},{condition:()=>window.Chart,name:"Chart.js"},{condition:()=>window.ChartDataLabels,name:"Datalabels插件"},{condition:()=>window.flatpickr,name:"Flatpickr"}];let s=0;const l=a.length,r=s/l*100;t.style.width=r+"%",n.textContent=`正在初始化系统... (${s}/${l})`;const c=a.map(e=>{return t=e.condition(),n=e.name,new Promise(e=>{const o=setInterval(()=>{t&&(clearInterval(o),e(n))},100);setTimeout(()=>{clearInterval(o),e(null)},5e3)});var t,n});for(let e=0;e<c.length;e++)try{await c[e],s++;const o=s/l*100;t.style.width=o+"%",n.textContent=`正在初始化系统... (${s}/${l})`}catch(n){console.warn("资源检查超时:",a[e].name),s++;const o=s/l*100;t.style.width=o+"%"}if(n.textContent="系统初始化完成...",setTimeout(()=>{document.getElementById("mloading").style.display="none",document.getElementById("header").style.display="none"},300),!e)return ce("错误: Supabase客户端未正确初始化"),o.disabled=!0,o.textContent="系统未初始化",o.style.background="#e53e3e",o.style.cursor="not-allowed",i.innerHTML='<p style="color: #e53e3e; padding: 1rem;">系统初始化失败，请刷新页面</p>',void(i.style.display="block");const d=await async function(){if(!e)return!1;try{const{data:{user:t},error:n}=await e.auth.getUser();if(t){ee=t;const e=t.email.split("@")[0],n={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[e]||e;return H.textContent=n,V.style.display="block",C.style.display="none",x.style.display="block",ce(`欢迎 ${n}！`,"success"),!0}return V.style.display="none",C.style.display="block",!1}catch(e){return ce(`用户认证发生错误: ${e}`,"error"),!1}}();document.getElementById("switchWarehouseBtn").addEventListener("click",de),window.addEventListener("resize",_e),function(){A&&A.addEventListener("click",e=>{e.stopPropagation(),F.style.display="block"===F.style.display?"none":"block"});document.addEventListener("click",e=>{F&&"block"===F.style.display&&!A.contains(e.target)&&(F.style.display="none")}),O&&O.addEventListener("click",async()=>{try{const{error:t}=await e.auth.signOut();if(t)return void ce(`退出登录失败: ${t.message}`,"error");ce("已成功退出登录","success"),setTimeout(()=>{window.location.reload()},500)}catch(e){ce("退出登录时发生错误","error")}})}(),d?$e():(D.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");D.forEach(e=>e.classList.remove("active")),e.classList.add("active"),L.classList.remove("active"),q.classList.remove("active"),"login"===t?(L.classList.add("active"),L.style.display="block",q.style.display="none"):(q.classList.add("active"),q.style.display="block",L.style.display="none")})}),B.addEventListener("click",async()=>{const t=_.value,n=$.value;if(!t||!n)return void ce("请输入邮箱和密码","warning");const{data:o,error:a}=await e.auth.signInWithPassword({email:t,password:n});if(ce("登录成功！","success"),a)return void ce("登录失败: 请检查用户名或密码是否正确！","error");ee=o.user;const s=ee.email.split("@")[0],l={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[s]||s;H.textContent=l,V.style.display="block",C.style.display="none",x.style.display="block",ce(`欢迎 ${l}！`,"success"),$e()}),$&&$.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),B.click())}),M.addEventListener("click",async()=>{const t=k.value,n=S.value,o=I.value;if(!t||!n)return void ce("请输入邮箱和密码","warning");const a={email:t,password:n,options:{data:{}}};o&&(a.phone=o);try{const{data:n,error:o}=await e.auth.signUp(a);if(o)return void ce("注册失败: 该功能被禁止，请与管理员联系！","error");ce("注册成功! 请检查您的邮箱进行验证","success"),D.forEach(e=>e.classList.remove("active")),document.querySelector('.auth-tab[data-tab="login"]').classList.add("active"),L.classList.add("active"),L.style.display="block",q.style.display="none",_.value=t}catch(e){ce(`注册异常: ${e.message}`,"error")}}),T.addEventListener("click",async t=>{t.preventDefault();const n=_.value;if(!n)return void ce("请输入您的邮箱","warning");const{data:o,error:a}=await e.auth.resetPasswordForEmail(n,{redirectTo:window.location.href});a?ce(`发送重置邮件失败: ${a.message}`,"error"):ce("密码重置邮件已发送，请检查您的邮箱","success")}))});