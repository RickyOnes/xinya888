let e;async function t(e,t,n=null){let o;o=t.startsWith("auth/")?t.replace("auth/","auth/v1/"):`api/${t}`;let a=`/${o}`;const s={method:e,headers:{"Content-Type":"application/json"}},l=localStorage.getItem("supabase.auth.token");if(l)try{const e=JSON.parse(l);e.access_token&&(s.headers.Authorization=`Bearer ${e.access_token}`)}catch(e){console.error("Failed to parse token",e)}if("GET"===e&&n){const e=[];for(const[t,o]of Object.entries(n))"object"==typeof o&&null!==o?o.gte&&o.lte?(e.push(`${t}=gte.${o.gte}`),e.push(`${t}=lte.${o.lte}`)):"select"===t?e.push(`select=${o}`):"offset"!==t&&"limit"!==t||e.push(`${t}=${o}`):e.push(`${t}=${o}`);e.length>0&&(a=`${a}?${e.join("&")}`)}else"GET"!==e&&(s.body=null==n?"{}":JSON.stringify(n));try{const e=await fetch(a,s);if(!e.ok){let t;try{t=await e.json()}catch{t={error:`HTTP error! status: ${e.status}`}}throw new Error(t.error||t.message||`HTTP error! status: ${e.status}`)}if("auth/v1/logout"===o){const t=e.headers.get("content-type");if(t&&t.includes("application/json")){return await e.json()}return{message:"Successfully signed out"}}const t=await e.json();return"auth/v1/user"===o?{data:{user:t}}:t}catch(e){throw console.error("Request failed:",e),e}}function n(){if(!e)try{e={from:e=>({select:n=>t("GET",e,n),insert:n=>t("POST",e,n),update:n=>{const o={};return n.id&&(o.id=`eq.${n.id}`),t("PATCH",e,{...o,...n})},delete:()=>t("DELETE",e)}),auth:{getUser:async()=>{try{return await t("GET","auth/user")}catch(e){throw console.error("Get user error:",e),(e.message.includes("401")||e.message.includes("403"))&&localStorage.removeItem("supabase.auth.token"),e}},signInWithPassword:async e=>{try{const n=await t("POST","auth/login",{email:e.email,password:e.password});return n.access_token&&(n.expires_at||(n.expires_at=Math.floor(Date.now()/1e3)+604800),localStorage.setItem("supabase.auth.token",JSON.stringify(n))),n}catch(e){throw console.error("Sign in error:",e),e}},signUp:async e=>{try{const n=await t("POST","auth/signup",{email:e.email,password:e.password,phone:e.phone});return n.access_token&&localStorage.setItem("supabase.auth.token",JSON.stringify(n)),n}catch(e){throw console.error("Sign up error:",e),e}},signOut:async()=>{try{const e=await t("POST","auth/logout");return localStorage.removeItem("supabase.auth.token"),e}catch(e){throw console.error("Sign out error:",e),e}},resetPasswordForEmail:async(e,n)=>{try{return await t("POST","auth/reset-password",{email:e,redirectTo:n.redirectTo})}catch(e){throw console.error("Reset password error:",e),e}}}}}catch(e){ue("系统初始化失败，请刷新页面或联系管理员","error")}return e}const o=document.getElementById("dateRangePicker"),a=document.getElementById("queryBtn"),s=document.getElementById("clearBtn"),l=document.getElementById("summaryTable").querySelector("tbody"),r=document.getElementById("detailTable").querySelector("tbody"),i=document.getElementById("loading"),c=document.getElementById("totalQuantity"),d=document.getElementById("totalAmount"),u=document.getElementById("totalProducts"),p=document.getElementById("totalBrands"),h=(document.getElementById("toggleDetails"),document.getElementById("detailSection")),m=document.getElementById("totalProfit"),g=(document.getElementById("switchWarehouseBtn"),document.getElementById("warehouseSelector")),y=document.getElementById("warehouseOptions"),f=document.getElementById("brandSelector"),b=document.getElementById("brandOptions"),v=document.getElementById("productSelector"),w=document.getElementById("productOptions"),E=document.getElementById("customerSelector"),C=document.getElementById("customerOptions"),_=document.getElementById("authContainer"),$=document.getElementById("appContainer"),S=document.getElementById("loginForm"),x=document.getElementById("registerForm"),k=document.getElementById("loginEmail"),L=document.getElementById("loginPassword"),q=document.getElementById("registerEmail"),B=document.getElementById("registerPassword"),I=document.getElementById("registerPhone"),T=document.getElementById("loginBtn"),M=document.getElementById("registerBtn"),D=document.getElementById("forgotPasswordLink"),A=document.querySelectorAll(".auth-tab"),O=document.getElementById("userStatus"),H=document.getElementById("userInfo"),V=document.getElementById("userName"),F=document.getElementById("userMenu"),z=document.getElementById("logoutBtn"),P=document.getElementById("chartToggleBtn"),j=document.getElementById("returnsTableContainer"),W=document.getElementById("returnsTable"),X=document.getElementById("exportDetails");let N,R,G,J,U,Y=[],Q=[],Z=[],K={},ee=null,te=[],ne=null,oe="default",ae=[],se=[],le="",re="",ie="chart";function ce(e){return"number"!=typeof e?"0":e.toLocaleString("zh-CN",{minimumFractionDigits:0,maximumFractionDigits:2})}function de(){const e=new Date,t=new Date;1===e.getDate()?(t.setMonth(t.getMonth()-1),t.setDate(1),e.setMonth(e.getMonth()-1),e.setDate(new Date(e.getFullYear(),e.getMonth()+1,0).getDate())):(t.setDate(1),e.setDate(e.getDate()-1)),N.setDate([t,e])}function ue(e,t="error"){const n=document.getElementById("custom-alert");n&&n.remove();const o=document.createElement("div");o.id="custom-alert",o.className=`rounded-alert ${t}`,o.innerHTML=`\n    <div class="alert-content">\n      <i class="fas fa-${"error"===t?"exclamation-circle":"check-circle"}"></i>\n      <span>${e}</span>\n    </div>\n  `,document.body.appendChild(o);const a=o.offsetWidth,s=(window.innerWidth-a)/2;o.style.top="20px",o.style.left=`${s}px`,setTimeout(()=>{o.classList.add("fade-out"),setTimeout(()=>o.remove(),300)},2e3)}function pe(){if(h.classList.contains("visible")){h.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}oe="default"===oe?"longqiao":"default";const e=document.querySelector(".filters-row");"longqiao"===oe?e.classList.add("longqiao"):e.classList.remove("longqiao"),function(){const e=document.querySelector("header h1"),t=document.getElementById("profitCard"),n=document.getElementById("totalProducts").closest(".stat-card");"longqiao"===oe?(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 隆桥仓库销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-warehouse)").innerHTML='<i class="fas fa-user"></i> 销售人员',t.style.display="block"):(e.innerHTML='<img src="icon64.png" alt="应用图标" style="border-radius: 8px; filter: drop-shadow(0px 2px 4px rgba(0, 0, 0, 0.5));"> 多多买菜销售数据查询系统',document.querySelector(".filter-group label:has(i.fas.fa-user)").innerHTML='<i class="fas fa-warehouse"></i> 仓库',t.style.display="none",n.style.display="block");const o=document.getElementById("customerFilterGroup");o&&(o.style.display="longqiao"===oe?"block":"none")}(),P.style.display="default"===oe?"flex":"none",Ce(),de(),ie="returns",fe(),be().then(()=>{R.reset(),G.reset(),J.reset(),U&&U.reset(),function(){const e=document.querySelector("#detailTable thead");let t=`\n    <tr>\n      <th>日期</th>\n      <th>${"longqiao"===oe?"客户名称":"商品ID"}</th> \n      <th>商品名称</th>\n      <th>品牌</th>\n      <th>${"longqiao"===oe?"销售人员":"仓库"}</th>\n      <th>销量</th>\n      <th>${"longqiao"===oe?"成本":"单价"}</th>\n      <th>金额</th>\n  `;"longqiao"===oe&&(t+="<th>毛利</th>");t+="</tr>",e.innerHTML=t}(),ve(),Le()})}class he{constructor(e,t,n){this.selector=e,this.optionsContainer=t,this.placeholder=n,this.selectedValues=[],this.allOptions=[],this.clearBtn=e.querySelector(".clear-btn"),this.initEvents()}initEvents(){this.selector.addEventListener("click",e=>this.toggleDropdown(e)),this.clearBtn.addEventListener("click",e=>this.clearSelection(e)),this.optionsContainer.addEventListener("change",e=>this.handleOptionChange(e)),this.optionsContainer.addEventListener("mouseenter",()=>this.optionsContainer.classList.add("active")),this.optionsContainer.addEventListener("mouseleave",()=>this.optionsContainer.classList.remove("active"))}toggleDropdown(e){if(e.target.classList.contains("tag-remove")||e.target.classList.contains("tag")||e.target.closest(".tag-remove")||e.target.closest(".tag"))return;e.stopPropagation(),me();if(!this.optionsContainer.classList.contains("visible")){this.optionsContainer.classList.add("visible"),ee=this.optionsContainer;this.selector.querySelector(".arrow").classList.replace("fa-chevron-down","fa-chevron-up"),this.positionDropdown()}}positionDropdown(){const e=this.selector.getBoundingClientRect(),t=this.selector.parentElement.getBoundingClientRect();this.optionsContainer.style.width=`${e.width}px`,this.optionsContainer.style.left=e.left-t.left+"px",this.optionsContainer.style.top=e.bottom-t.top+"px"}clearSelection(e){e.stopPropagation(),this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1),("brandSelector"===this.selector.id||"productSelector"===this.selector.id)&&(te=[],ge())}handleOptionChange(e){if(!e.target.matches('input[type="checkbox"]'))return;const t=e.target,n=t.value;if(t.id.startsWith("selectAll")){const e=this.optionsContainer.querySelectorAll(`input[type="checkbox"]:not([id="${t.id}"])`);t.checked?(this.selectedValues=this.allOptions.map(e=>e.value),e.forEach(e=>e.checked=!0)):(this.selectedValues=[],e.forEach(e=>e.checked=!1))}else{if(t.checked)this.selectedValues.includes(n)||this.selectedValues.push(n);else{const e=this.selectedValues.indexOf(n);e>-1&&this.selectedValues.splice(e,1)}this.updateSelectAllState()}this.updateDisplay(),"brandSelector"===this.selector.id&&(te=[],ge(),"longqiao"===oe&&function(){const e=G.selectedValues,t=R.selectedValues;let n=[];n=e.length>0||t.length>0?ae.filter(n=>se.some(o=>o.customer===n&&(0===e.length||e.includes(o.brand))&&(0===t.length||t.includes(o.sales)))):ae;U.setOptions(n.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),U&&U.reset()}()),"warehouseSelector"===this.selector.id&&function(){if(!se||0===se.length)return;try{let e=[...se];"longqiao"===oe?R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.sales))):R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.warehouse)));const t=new Map;if(K={},e.forEach(e=>{e.product_id&&(t.has(e.product_id)||t.set(e.product_id,{product_id:e.product_id,product_name:e.product_name||"未知商品"}),K[e.product_id]=e.brand||"无品牌")}),Z=Array.from(t.values()),Q=[...new Set(Object.values(K))].sort(),G.setOptions(Q.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),ge(),"longqiao"===oe){const t=[...new Set(e.map(e=>e.customer).filter(e=>e))].sort();U.setOptions(t.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),U&&U.reset(),G&&G.reset()}}catch(e){ue(`重新加载品牌和商品选项失败: ${e}`,"error")}}()}updateDisplay(){const e=this.selector.querySelector(".placeholder"),t=this.selector.querySelector(".selected-display"),n=this.selector.querySelector(".arrow");if(t.innerHTML="",0===this.selectedValues.length)return e.textContent=`全部${this.placeholder}`,e.style.display="block",t.style.display="none",n.style.display="block",n.classList.replace("fa-times","fa-chevron-down"),void(this.clearBtn.style.display="none");e.style.display="none",t.style.display="flex";const o=this.selectedValues.slice(0,5),a=this.selectedValues.length-5;if(o.forEach(e=>{const n=this.allOptions.find(t=>t.value===e);n&&t.insertAdjacentHTML("beforeend",`\n        <div class='tag' data-value='${e}'>\n          ${n.label}\n          <span class='tag-remove'><i class="far fa-circle-xmark"></i></span> \n        </div>\n      `)}),a>0){const e=document.createElement("div");e.className="tag more-tag",e.textContent=`...等${this.selectedValues.length}项`,t.appendChild(e)}n.style.display="none",this.clearBtn.style.display="block"}reset(){this.selectedValues=[],this.updateDisplay();this.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1)}updateSelectAllState(){const e=this.optionsContainer.querySelector('input[id^="selectAll"]');if(e){const t=this.optionsContainer.querySelectorAll('input[type="checkbox"]:not([id^="selectAll"])');e.checked=t.length>0&&Array.from(t).every(e=>e.checked)}}setOptions(e){this.allOptions=e,this.renderOptions(),this.updateDisplay()}renderOptions(){this.optionsContainer.innerHTML="";const e=document.createElement("div");e.className="option",e.innerHTML=`\n      <input type="checkbox" id="selectAll${this.selector.id}">\n      <label for="selectAll${this.selector.id}">全选</label>\n    `,this.optionsContainer.appendChild(e),this.allOptions.forEach(e=>{const t=document.createElement("div");t.className="option",t.innerHTML=`\n        <input type="checkbox" id="${this.selector.id}-${e.value}" \n              value="${e.value}" ${this.selectedValues.includes(e.value)?"checked":""}>\n        <label for="${this.selector.id}-${e.value}">${e.label}</label>\n      `,this.optionsContainer.appendChild(t)})}}function me(){document.querySelectorAll(".options-container").forEach(e=>{e.classList.remove("visible");const t=e.previousElementSibling.querySelector(".arrow");t&&t.classList.replace("fa-chevron-up","fa-chevron-down")}),ee=null}function ge(){w.innerHTML="";const e=document.createElement("div");e.className="option",e.id="productSelectAll",e.innerHTML='\n    <input type="checkbox" id="selectAllProducts">\n    <label for="selectAllProducts">全选</label>\n  ',w.appendChild(e);let t=[],n=G.selectedValues.length;n>0?t=Z.filter(e=>K[e.product_id]&&G.selectedValues.includes(K[e.product_id])):(t=Z,n="全部"),J.selectedValues=[],t.forEach(e=>{const t=document.createElement("div");t.className="option";const n=J.selectedValues.includes(e.product_id);t.innerHTML=`\n      <input type="checkbox" id="product-${e.product_id}" \n             value="${e.product_id}" ${n?"checked":""}>\n      <label for="product-${e.product_id}">${e.product_name}</label>\n    `,w.appendChild(t)});v.querySelector(".placeholder").textContent=0===G.selectedValues.length?"全部商品":`已筛选${n}个品牌`,J.setOptions(t.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label)))}function ye(){if(!W)return;const e=W.querySelector("tbody"),t=W.closest(".returns-table-container"),n=t.querySelector(".returns-summary");if(n&&n.remove(),!e)return;e.innerHTML="";const o=Ee();if(!o||0===o.length)return void(e.innerHTML='\n      <tr>\n        <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n          未找到记录\n        </td>\n      </tr>\n    ');const a={};o.forEach(e=>{const t=e.product_id;a[t]||(a[t]={product_id:t,product_name:e.product_name,inbounds:0,sales_quantity:0,sorting_difference:0,returns:0}),a[t].inbounds+=e.inbounds||0,a[t].sales_quantity+=e.quantity||0,a[t].returns+=e.returns||0,a[t].sorting_difference+=e.difference||0});const s=Object.values(a).map(e=>{const t=e.sales_quantity-e.inbounds+e.returns+e.sorting_difference;return{...e,difference:t}}).filter(e=>0!==e.difference);s.sort((e,t)=>Math.abs(t.difference)-Math.abs(e.difference));const l=Object.values(a).reduce((e,t)=>e+(t.inbounds||0),0),r=Object.values(a).reduce((e,t)=>e+(t.returns||0),0),i=Object.values(a).reduce((e,t)=>e+(t.sales_quantity||0),0),c=Object.values(a).reduce((e,t)=>e+(t.sorting_difference||0),0),d=i-l+r+c,u=document.createElement("div");u.className="returns-summary",u.innerHTML='\n    <div class="summary-chart-container">\n      <canvas id="returnsSummaryChart"></canvas>\n    </div>\n  ',t.insertBefore(u,t.firstChild),setTimeout(()=>{!function(e,t,n,o,a){const s=document.getElementById("returnsSummaryChart");if(!s)return;s.chart&&s.chart.destroy();s.chart=new Chart(s,{type:"bar",data:{labels:["总入库(份)","总销售(份)","总退货(份)","分拣差异(份)","总差异(份)"],datasets:[{label:"数量",data:[e,t,n,o,Math.abs(a)],backgroundColor:["rgba(54, 162, 235, 0.7)","rgba(75, 192, 192, 0.7)","rgba(255, 99, 132, 0.7)","rgba(255, 159, 64, 0.7)",a<0?"rgba(255, 96, 64, 0.9)":"rgba(153, 102, 255, 0.9)"],borderColor:["rgba(54, 162, 235, 1)","rgba(75, 192, 192, 1)","rgba(255, 99, 132, 1)","rgba(255, 159, 64, 1)",a<0?"rgba(255, 105, 64, 1)":"rgba(153, 102, 255, 1)"],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},title:{display:!0,text:"入库销售退货数据分析",color:"#222",font:{size:window.innerWidth<=768?16:18,weight:"bold"},padding:{top:10,bottom:20}},tooltip:{callbacks:{label:function(e){const t=e.raw;return`数量: ${ce(4===e.dataIndex?a:t)}`}}},datalabels:{anchor:"end",align:"top",formatter:function(e,t){return 4===t.dataIndex?ce(Math.abs(a)):ce(e)},font:{weight:"bold",size:14},color:function(e){e.dataset.data[e.dataIndex];return 4===e.dataIndex?a<0?"#e53e3e":"#26cd3c":3===e.dataIndex?a>0?"#e53e3e":"#26cd3c":"#333"}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return ce(e)}},grid:{display:!1}},x:{grid:{display:!1}}},minBarLength:2},plugins:[ChartDataLabels]})}(l,i,r,c,d)},0),0!==s.length?s.forEach(t=>{const n=document.createElement("tr"),o=t.difference<0?'style="color: #e53e3e; font-weight: bold;"':'style="color: #26cd3c; font-weight: bold;"';n.innerHTML=`\n      <td>${t.product_name||"--"}</td>\n      <td>${ce(t.inbounds)}</td>\n      <td>${ce(t.sales_quantity)}</td>\n      <td>${ce(t.returns+t.sorting_difference)}</td>\n      <td ${o}>${ce(t.difference)}</td>\n    `,e.appendChild(n)}):e.innerHTML='\n      <tr>\n        <td colspan="6" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem; display: block; color: #28a745;"></i>\n          所有记录入库-销售-退货=0，无差异记录\n        </td>\n      </tr>\n    '}async function fe(){if("chart"===ie){ie="returns",P.innerHTML='<i class="fas fa-chart-pie"></i>';const e=document.getElementById("chartContainer");e&&(e.style.display="none"),j.style.display="block",j.classList.add("visible"),ye()}else{ie="chart",P.innerHTML='<i class="fas fa-exchange-alt"></i>';const e=document.getElementById("chartContainer");e&&(e.style.display="block"),j.style.display="none",j.classList.remove("visible")}}async function be(){try{i.style.display="block",Se();const t=N.selectedDates,n=t[0],o=t[1],a=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;le=a(n),re=a(o);const s="longqiao"===oe?"longqiao_records":"sales_records",l="longqiao"===oe?["sale_date","product_id","product_name","sales","quantity","customer","amount","cost","brand"]:["sale_date","product_id","product_name","warehouse","quantity","unit_price","brand","pieces","returns","inbounds","difference"],r={sale_date:{gte:le,lte:re}};if(console.time("加载销售记录时间"),se=await async function(t,n,o={}){try{const a=5e4;let s=[],l=0,r=!0,i={select:n.join(",")};for(Object.entries(o).forEach(([e,t])=>{Array.isArray(t)?i[e]=`in.(${t.join(",")})`:void 0!==t&&("object"==typeof t&&t.gte&&t.lte,i[e]=t)});r;){const n={...i,offset:l,limit:a},o=await e.from(t).select(n);if(o.error)throw o.error;const c=Array.isArray(o)?o:o.data||[];c.length>0&&(s=[...s,...c]),r=c.length===a,l+=a}return s}catch(e){throw ue(`从 ${t} 获取数据失败:${e}`,"error"),e}}(s,l,r),console.timeEnd("加载销售记录时间"),se.length>0){const e="longqiao"===oe?"sales":"warehouse";Y=[...new Set(se.map(t=>t[e]))].filter(e=>e).sort()}if(K={},se.length>0){const e=new Map;se.forEach(t=>{t.product_id&&!e.has(t.product_id)&&e.set(t.product_id,{product_id:t.product_id,product_name:t.product_name}),t.product_id&&t.brand&&(K[t.product_id]=t.brand)}),Z=Array.from(e.values()),Q=[...new Set(se.map(e=>e.brand))].filter(e=>e).sort()}return"longqiao"===oe&&se.length>0&&(ae=[...new Set(se.map(e=>e.customer))].filter(e=>e).sort()),R=new he(g,y,"longqiao"===oe?"销售人员":"仓库"),G=new he(f,b,"品牌"),J=new he(v,w,"商品"),U=new he(E,C,"客户"),U.setOptions(ae.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),R.setOptions(Y.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),G.setOptions(Q.map(e=>({value:e,label:e})).sort((e,t)=>e.label.localeCompare(t.label))),J.setOptions(Z.map(e=>({value:e.product_id,label:e.product_name})).sort((e,t)=>e.label.localeCompare(t.label))),"longqiao"===oe&&1===Q.length&&setTimeout(()=>{ve()},0),Promise.resolve()}catch(e){return ue(`筛选选项加载失败: ${e.message}`,"error"),Promise.reject(e)}finally{i.style.display="none",xe()}}function ve(){if(h.classList.contains("visible")){h.classList.remove("visible");document.querySelector("#toggleDetails i").classList.replace("fa-chevron-up","fa-chevron-down")}l.innerHTML="",r.innerHTML="",Ce();try{let e=se;"longqiao"===oe?R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.sales))):R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.warehouse))),G.selectedValues.length>0&&(e=e.filter(e=>G.selectedValues.includes(e.brand))),J.selectedValues.length>0&&(e=e.filter(e=>J.selectedValues.includes(e.product_id))),"longqiao"===oe&&U&&U.selectedValues.length>0&&(e=e.filter(e=>U.selectedValues.includes(e.customer))),function(e){const t=document.getElementById("summaryTable");let n=t.querySelector("thead");n||(n=document.createElement("thead"),t.insertBefore(n,t.firstChild));let o="<tr><th>品牌</th><th>总件数</th><th>总金额</th>";"longqiao"===oe&&(o+="<th>总毛利</th><th>费用发放</th>");o+="</tr>",n.innerHTML=o;let a=t.querySelector("tbody");a||(a=document.createElement("tbody"),t.appendChild(a));if(!e||0===e.length){c.textContent="0",d.textContent="¥0.00",u.textContent="0",p.textContent="0","longqiao"===oe&&(m.textContent="¥0.00");const e="longqiao"===oe?5:3;return void(a.innerHTML=`\n      <tr>\n          <td colspan="${e}" style="text-align: center; padding: 30px; color: #6c757d;">\n          <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n          无汇总数据\n        </td>\n      </tr>\n    `)}let s=0,l=0,r=0,i=0;const h=new Set,g=new Set,y=new Map;e.forEach(e=>{let t,n;if(e.product_id&&g.add(e.product_id),e.brand&&h.add(e.brand),"longqiao"===oe)if(t=e.amount||0,n=e.cost||0,0===t)i+=n;else{const o=e.quantity||0;s+=o,l+=t,r+=t-n}else{const o=e.pieces||0,a=e.quantity||0,r=e.unit_price||0;t=a*r,s+=o,l+=t,n=r}if("longqiao"!==oe||0!==t){const o=e.brand||"未知品牌";y.has(o)||y.set(o,{brand:o,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const a=y.get(o);"longqiao"===oe?(a.total_quantity+=e.quantity||0,a.total_amount+=t,a.total_cost+=n,a.profit+=t-n):(a.total_quantity+=e.pieces||0,a.total_amount+=t)}if("longqiao"===oe&&0===t){const t=e.brand||"未知品牌";y.has(t)||y.set(t,{brand:t,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});y.get(t).free_issue+=n}});const f="longqiao"===oe&&(1===h.size||1===Q.length),b=1===h.size?Array.from(h)[0]:1===Q.length?Q[0]:null;if(f&&b){const t=new Map;let o=0,s=0,l=0,r=0;const i=new Set;e.forEach(e=>{if(e.brand===b){let n,a;if(e.product_id&&i.add(e.product_id),"longqiao"===oe){n=e.amount||0,a=e.cost||0;const i=e.sales||"未知销售人员";t.has(i)||t.set(i,{sales:i,total_quantity:0,total_amount:0,total_cost:0,profit:0,free_issue:0});const c=t.get(i);if(0===n)c.free_issue+=a,r+=a;else{const t=e.quantity||0;c.total_quantity+=t,c.total_amount+=n,c.profit+=n-a,o+=t,s+=n,l+=n-a}}}}),c.textContent=ce(o),d.textContent=`¥${ce(s)}`,m.textContent=`¥${ce(l)}`,p.textContent=`¥${ce(r)}`,p.style.color="#e53e3e",u.textContent=ce(i.size);document.querySelectorAll(".stat-card .stat-label")[3].textContent="费用发放",m.style.color=l<=0?"#e53e3e":"#4361ee",n.innerHTML="<tr><th>销售人员</th><th>总件数</th><th>总金额</th><th>总毛利</th><th>费用发放</th></tr>";const h=Array.from(t.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",h.forEach(e=>{const t=document.createElement("tr"),n=e.profit<0?'style="color: #e53e3e; font-weight: bold;"':"";t.innerHTML=`\n          <td>${e.sales}</td>\n          <td>${ce(e.total_quantity)}</td>\n          <td>¥${ce(e.total_amount)}</td>\n          <td ${n}>¥${ce(e.profit)}</td> \n          <td>¥${ce(e.free_issue)}</td> \n      `,a.appendChild(t)}),h.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data"><br><br>无销售人员数据可展示</div>',P.style.display="default"===oe?"flex":"none",0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{const t=["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"];if(e>t.length)for(let n=t.length;n<e;n++)t.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return t.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.sales),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"92%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:window.innerWidth<=768?10:14,weight:"bold"},padding:window.innerWidth<=768?9:20,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"销售人员销售金额占比",font:{size:window.innerWidth<=768?16:18,weight:"bold"},color:"#222",padding:{top:20,bottom:10}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:13,weight:"bold"},bodyFont:{size:window.innerWidth<=768?10:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ce(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(h):Ce()}else{c.textContent=ce(s),d.textContent=`¥${ce(l)}`;const t=document.querySelectorAll(".stat-card .stat-label");"longqiao"===oe?(p.textContent=`¥${ce(i)}`,p.style.color="#e53e3e",t[3].textContent="费用发放",!(r<=0)||(m.style.color="#e53e3e"),m.textContent=`¥${ce(r)}`):(p.textContent=ce(h.size),p.style.color="",t[3].textContent="品牌数量"),u.textContent=ce(g.size);const n=Array.from(y.values()).sort((e,t)=>t.total_amount-e.total_amount);a.innerHTML="",n.forEach(e=>{const t=document.createElement("tr");let n=`\n          <td>${e.brand}</td>\n          <td>${ce(e.total_quantity)}</td>\n          <td>¥${ce(e.total_amount)}</td>\n      `;if("longqiao"===oe){n+=`\n              <td ${e.profit<0?'style="color: #e53e3e; font-weight: bold;"':""}>¥${ce(e.profit)}</td> \n              <td>¥${ce(e.free_issue)}</td> \n          `}t.innerHTML=n,a.appendChild(t)}),e&&e.length>0?function(e){const t=document.getElementById("chartContainer");if(t.innerHTML=e.length>0?'<canvas id="brandChart"></canvas>':'<div class="no-chart-data"><br><br>无品牌数据可展示</div>',P.style.display="default"===oe?"flex":"none",0===e.length)return;const n=document.getElementById("brandChart").getContext("2d");if(!n)return;const o=e=>{if(baseColors="longqiao"===oe?["#4BC0C0","#f54444ff","#36A2EB","#F15BB5","#FFCE56","#26cd3cff","#9966FF","#FF9F40","#1982C4","#6A4C93"]:["#26cd3cff","#FFCE56","#f54444ff","#36A2EB","#F15BB5","#9966FF","#FF9F40","#6A4C93","#4BC0C0","#1982C4"],e>baseColors.length)for(let t=baseColors.length;t<e;t++)baseColors.push(`#${Math.floor(16777215*Math.random()).toString(16)}`);return baseColors.slice(0,e)},a=new Chart(n,{type:"pie",data:{labels:e.map(e=>e.brand),datasets:[{data:e.map(e=>e.total_amount),backgroundColor:o(e.length),borderWidth:1,borderColor:"#fff",hoverOffset:15,radius:"92%"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{size:window.innerWidth<=768?10:14,weight:"bold"},padding:window.innerWidth<=768?9:20,usePointStyle:!0,color:"#333"}},title:{display:!0,text:"品牌销售金额占比",font:{size:window.innerWidth<=768?16:18,weight:"bold"},color:"#222",padding:{top:20,bottom:10}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleFont:{size:13,weight:"bold"},bodyFont:{size:window.innerWidth<=768?10:12},callbacks:{label:function(e){const t=e.label||"",n=e.raw||0,o=e.chart.getDatasetMeta(0).total,a=Math.round(n/o*100);return`${t}: ¥${ce(n)} (${a}%)`}}},datalabels:{display:!0,formatter:(e,t)=>{const n=t.chart.getDatasetMeta(0).total,o=Math.round(e/n*100),a=t.chart.data.labels[t.dataIndex];return o<5?null:`${a}\n${o}%`},color:"#222",font:{weight:"bold",size:window.innerWidth<=768?8:12},align:"end",anchor:"center",offset:0,clip:!1,textAlign:"center",padding:2}},animation:{animateRotate:!0,animateScale:!0}},plugins:[ChartDataLabels]});t.chartInstance=a}(n):Ce()}setTimeout(()=>{!function(){const e=document.getElementById("returnsTableContainer"),t=document.querySelector(".summary-table-container"),n=document.querySelector(".chart-container");if(t&&n){const o=t.offsetHeight;n.style.height=`${o}px`,e&&(e.style.maxHeight=`${o}px`),n.chartInstance&&n.chartInstance.resize()}}()},0)}(e),we(e,!1),"returns"===ie&&ye()}catch(e){console.error("查询错误详情:",e),i.innerHTML=`\n      <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n        <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">数据加载失败</p>\n        <p>${e.message}</p>\n      </div>\n    `}}function we(e,t=!1){const n=document.getElementById("detailCount");e&&0!==e.length?n.textContent=`(${e.length}条)`:n.textContent="(0条数据)",t&&setTimeout(()=>{try{const t=r;if(t.innerHTML="",e&&e.length>0&&e.sort((e,t)=>new Date(t.sale_date)-new Date(e.sale_date)),!e||0===e.length)return void(t.innerHTML=`\n          <tr>\n            <td colspan="${"longqiao"===oe?9:8}" style="text-align: center; padding: 30px; color: #6c757d;">\n              <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n              未找到匹配的记录\n            </td>\n          </tr>\n        `);e.forEach(e=>{const n=document.createElement("tr");let o,a,s;if("longqiao"===oe?(o=e.amount||0,a=e.sales||"--",s=e.cost||0):(o=(e.quantity||0)*(e.unit_price||0),a=e.warehouse||"--",s=e.unit_price||0),n.innerHTML=`\n          <td>${e.sale_date||"--"}</td>\n          <td>${"longqiao"===oe?e.customer||"--":e.product_id||"--"}</td>\n          <td>${e.product_name||"--"}</td>\n          <td>${e.brand||"--"}</td>\n          <td>${a}</td>\n          <td>${ce(e.quantity||0)}</td>\n          <td>${s}</td>\n          <td>¥${ce(o)}</td>\n        `,"longqiao"===oe){const t=(e.amount||0)-(e.cost||0),o=t<0?'style="color: #e53e3e; font-weight: bold;"':"";n.innerHTML+=`<td ${o}>¥${ce(t)}</td>`}t.appendChild(n)})}catch(e){console.error("渲染详细表格时出错:",e),r.innerHTML=`\n        <tr>\n          <td colspan="${"longqiao"===oe?9:8}" style="text-align: center; padding: 30px; color: #e53e3e;">\n            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>\n            <p>渲染表格时发生错误</p>\n          </td>\n        </tr>\n      `}},0)}function Ee(){let e=se;return"longqiao"===oe?R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.sales))):R.selectedValues.length>0&&(e=e.filter(e=>R.selectedValues.includes(e.warehouse))),G.selectedValues.length>0&&(e=e.filter(e=>G.selectedValues.includes(e.brand))),J.selectedValues.length>0&&(e=e.filter(e=>J.selectedValues.includes(e.product_id))),"longqiao"===oe&&U&&U.selectedValues.length>0&&(e=e.filter(e=>U.selectedValues.includes(e.customer))),e}function Ce(){const e=document.getElementById("chartContainer");e.innerHTML='<div class="no-chart-data"><br><br>无品牌数据可展示</div>',P.style.display="default"===oe?"flex":"none",e.chartInstance&&(e.chartInstance.destroy(),e.chartInstance=null)}function _e(){R.reset(),G.reset(),J.reset(),U&&U.reset(),ge(),Ce(),de(),ie="returns",fe(),be().then(()=>{ve()})}function $e(){h.classList.toggle("visible");const e=document.querySelector("#toggleDetails i");h.classList.contains("visible")?(e.classList.replace("fa-chevron-down","fa-chevron-up"),i&&(i.style.display="block",Se()),h.classList.contains("visible")?(we(Ee(),!0),setTimeout(()=>{i&&(i.style.display="none",xe())},300)):i&&(i.style.display="none",xe())):(e.classList.replace("fa-chevron-up","fa-chevron-down"),r&&(r.innerHTML=""))}function Se(){let e=document.getElementById("loading-overlay");e?e.style.display="flex":(e=document.createElement("div"),e.id="loading-overlay",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(255, 255, 255, 0.2);\n      z-index: 999;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      backdrop-filter: blur(2px);\n    ",document.body.appendChild(e))}function xe(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}async function ke(){if(/MicroMessenger/i.test(navigator.userAgent))ue("微信浏览器不支持此功能，请在浏览器中打开网页导出数据。","warning");else{if("undefined"==typeof XLSX)try{if(i.style.display="block",Se(),await async function(){try{const e=document.createElement("script");return e.src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",new Promise((t,n)=>{e.onload=()=>t(window.XLSX),e.onerror=()=>n(new Error("XLSX库加载失败")),document.head.appendChild(e)})}catch(e){return ue(`数据导出错误：${e}`,"error"),null}}(),!window.XLSX)throw new Error("XLSX库加载失败")}catch(e){return void ue("导出功能暂时不可用。")}try{const e=Ee();if(!e||0===e.length)return void ue("没有数据可导出","warning");const t=XLSX.utils.book_new(),n=e.map(e=>{let t,n,o;"longqiao"===oe?(t=e.amount||0,n=e.sales||"--",o=e.cost||0):(t=(e.quantity||0)*(e.unit_price||0),n=e.warehouse||"--",o=e.unit_price||0);const a={"日期":e.sale_date||"--"};if("longqiao"===oe?a["客户名称"]=e.customer||"--":a["商品ID"]=e.product_id||"--",a["商品名称"]=e.product_name||"--",a["品牌"]=e.brand||"--","longqiao"===oe?a["销售人员"]=n:a["仓库"]=n,a["销量"]=e.quantity||0,"longqiao"===oe?a["成本"]=o:a["单价"]=o,a["金额"]=t,"longqiao"===oe){const t=(e.amount||0)-(e.cost||0);a["毛利"]=t}return a}),o=XLSX.utils.json_to_sheet(n);XLSX.utils.book_append_sheet(t,o,"销售记录");const a=`${"longqiao"===oe?"隆桥仓库":"多多买菜"}_销售记录_${le}_${re}.xlsx`;i.style.display="none",xe(),XLSX.writeFile(t,a),ue("数据导出成功","success")}catch(e){ue(`导出失败: ${e.message}`,"error")}}}function Le(){const e=document.getElementById("totalProducts").closest(".stat-card");"longqiao"===oe&&window.innerWidth<800?e.style.display="none":"longqiao"===oe&&(e.style.display="block")}function qe(){let e;N=flatpickr(o,{mode:"range",dateFormat:"Y-m-d",static:!0,onChange:function(e){2===e.length&&t()}}),N&&de(),X.addEventListener("click",ke),P.addEventListener("click",fe);const t=()=>{clearTimeout(e),e=setTimeout(()=>{be().then(()=>{ve(),Le()}).catch(console.error)},500)};be().then(()=>{a.addEventListener("click",ve),s.addEventListener("click",_e),document.getElementById("toggleDetails").addEventListener("click",$e),ve()}).catch(e=>{console.error("初始化失败:",e),i.innerHTML=`\n        <div style="text-align: center; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n          <div style="color: #e53e3e; font-size: 3rem; margin-bottom: 1rem;">⚠️</div>\n          <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">初始化失败</p>\n          <p>${e.message}</p>\n        </div>\n      `,i.style.display="block"}),document.addEventListener("click",e=>{g.contains(e.target)||y.contains(e.target)||f.contains(e.target)||b.contains(e.target)||v.contains(e.target)||w.contains(e.target)||E.contains(e.target)||C.contains(e.target)||me()},!0),document.querySelectorAll(".select-box").forEach(e=>{e.addEventListener("click",t=>{const n=t.target.closest(".tag-remove");if(!n)return;t.stopPropagation(),t.preventDefault();const o=n.closest(".tag"),a=e.id,s=o.dataset.value;if("warehouseSelector"===a){const e=y.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("brandSelector"===a){const e=b.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("productSelector"===a){const e=w.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}else if("customerSelector"===a){const e=C.querySelector(`input[value="${s}"]`);if(e){e.checked=!1;const t=new Event("change",{bubbles:!0});e.dispatchEvent(t)}}})}),window.addEventListener("scroll",()=>{me()}),window.addEventListener("resize",()=>{if(ee){const e=ee.previousElementSibling;e&&("warehouseSelector"===e.id?R.positionDropdown():"brandSelector"===e.id?G.positionDropdown():"productSelector"===e.id?J.positionDropdown():"customerSelector"===e.id&&U.positionDropdown())}}),function(){const e=document.querySelector(".chart-container"),t=document.querySelector(".returns-table-container"),n=document.querySelector(".summary-table-container");if(!e||!t||!P)return;function o(){let n;n="none"!==e.style.display?e:t,P.style.transition="none";const o=n.getBoundingClientRect(),a=n.parentElement.getBoundingClientRect(),s=o.left-a.left+10,l=o.top-a.top+10;P.style.left=`${s}px`,P.style.top=`${l}px`}if(window.ResizeObserver){const a=new ResizeObserver(o);a.observe(e),a.observe(t),a.observe(n)}o()}()}document.addEventListener("DOMContentLoaded",async()=>{const t=await async function(){if(n(),!e)return!1;try{const t=localStorage.getItem("supabase.auth.token");if(!t)return O.style.display="none",_.style.display="block",!1;let n;try{n=JSON.parse(t)}catch(e){return localStorage.removeItem("supabase.auth.token"),O.style.display="none",_.style.display="block",!1}if(n.expires_at){const e=Math.floor(Date.now()/1e3);if(n.expires_at<e)return localStorage.removeItem("supabase.auth.token"),O.style.display="none",_.style.display="block",!1}const o=await e.auth.getUser();if(o&&o.data&&o.data.user){ne=o.data.user;const e=ne.email.split("@")[0],t={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[e]||e;return V.textContent=t,O.style.display="block",_.style.display="none",$.style.display="block",ue(`欢迎 ${t}！`,"success"),!0}return localStorage.removeItem("supabase.auth.token"),O.style.display="none",_.style.display="block",!1}catch(e){return console.error("Auth init error:",e),localStorage.removeItem("supabase.auth.token"),O.style.display="none",_.style.display="block",!1}}();document.getElementById("switchWarehouseBtn").addEventListener("click",pe),window.addEventListener("resize",Le),function(){H&&H.addEventListener("click",e=>{e.stopPropagation(),F.style.display="block"===F.style.display?"none":"block"});document.addEventListener("click",e=>{F&&"block"===F.style.display&&!H.contains(e.target)&&(F.style.display="none")}),z&&z.addEventListener("click",async()=>{try{const{error:t}=await e.auth.signOut();if(t)return void ue(`退出登录失败: ${t.message}`,"error");ue("已成功退出登录","success"),setTimeout(()=>{window.location.reload()},500)}catch(e){ue("退出登录时发生错误","error")}})}(),t?qe():(A.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-tab");A.forEach(e=>e.classList.remove("active")),e.classList.add("active"),S.classList.remove("active"),x.classList.remove("active"),"login"===t?(S.classList.add("active"),S.style.display="block",x.style.display="none"):(x.classList.add("active"),x.style.display="block",S.style.display="none")})}),T.addEventListener("click",async()=>{const t=k.value,n=L.value;if(t&&n)try{const o=await e.auth.signInWithPassword({email:t,password:n});if(!o||!o.access_token)return void ue("登录失败: 请检查用户名或密码是否正确！","error");ne=o.user,ue("登录成功！","success");const a=ne.email.split("@")[0],s={162004332:"系统管理员",rickyone:"数据管理员",13762405681:"王英",ksf2025:"康师傅",pepsi_cola:"百事可乐",coca_cola:"可口可乐",15096086678:"娟子"}[a]||a;V.textContent=s,O.style.display="block",_.style.display="none",$.style.display="block",ue(`欢迎 ${s}！`,"success"),qe()}catch(e){console.error("Login error:",e),ue(`登录过程中发生错误: ${e.message}`,"error")}else ue("请输入邮箱和密码","warning")}),L&&L.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),T.click())}),M.addEventListener("click",async()=>{const t=q.value,n=B.value,o=I.value;if(t&&n)try{const{data:a,error:s}=await e.auth.signUp({email:t,password:n,phone:o,options:{data:{signup_source:"web_app"}}});if(s)return void ue(`注册失败: ${s.message}`,"error");ue("注册成功! 请检查您的邮箱进行验证","success"),A.forEach(e=>e.classList.remove("active")),document.querySelector('.auth-tab[data-tab="login"]').classList.add("active"),S.classList.add("active"),S.style.display="block",x.style.display="none",k.value=t}catch(e){ue("注册异常: 该功能已关闭，请联系管理员！","error")}else ue("请输入邮箱和密码","warning")}),D.addEventListener("click",async t=>{t.preventDefault();const n=k.value;if(n)try{const{error:t}=await e.auth.resetPasswordForEmail(n,{redirectTo:`${window.location.origin}/reset-password`});if(t)return void ue(`发送重置邮件失败: ${t.message}`,"error");ue("密码重置邮件已发送，请检查您的邮箱","success")}catch(e){ue(`发送重置邮件失败: ${e.message}`,"error")}else ue("请输入您的邮箱","warning")}))});